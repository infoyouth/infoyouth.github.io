name: "🚧 Build and Test the site"

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 💎 Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true
      - name: 📦 Install Dependencies
        run: bundle install
        
      - name: 🧹 Lint Ruby Code
        run: |
          chmod +x _plugins/posts-lastmod-hook.rb
          run: bundle exec rubocop      

      - name: 🛠️ Build Site with Jekyll
        run: bundle exec jekyll build -d "_site"

      - name: 🔍 Run HTMLProofer
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
          if grep -qE '(_posts/|_layouts/|_includes/)' changed_files.txt; then
            echo "HTML files affected. Running HTMLProofer..."
            bundle exec htmlproofer _site \
              --disable-external \
              --ignore-urls "/^http:\/\/127.0.0.1/,/^http:\/\/0.0.0.0/,/^http:\/\/localhost/"
          else
            echo "No HTML changes detected. Skipping HTMLProofer."
          fi

      - name: Upload Built Site Artifact
        uses: actions/upload-artifact@v3
        with:
          name: built-site
          path: _site


