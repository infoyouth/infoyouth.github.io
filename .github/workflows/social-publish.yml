---
name: ðŸ“¢ Social Media Auto-Publisher

# Trigger after successful deployment
"on":
  workflow_run:
    workflows: ["Deploy"]
    types: [completed]
    branches:
      - main

permissions:
  contents: write

jobs:
  detect-and-publish:
    name: ðŸ” Detect New Posts & Publish
    # Only run if deploy succeeded
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-24.04

    steps:
      - name: ðŸ› ï¸ Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 2  # Need 2 commits to compare for new files

      - name: ðŸ” Detect NEW Posts (Added, Not Modified)
        id: detect
        run: |
          echo "ðŸ”Ž Checking for newly added markdown files..."
          
          # Get list of NEW files added in last commit (status 'A' = Added)
          NEW_POST_FILES=$(git diff --name-status HEAD~1 HEAD | \
            grep '^A' | \
            grep '_posts/.*\.md$' | \
            awk '{print $2}')
          
          if [ -z "$NEW_POST_FILES" ]; then
            echo "ðŸ“­ No new posts detected. Skipping social publishing."
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… New posts detected:"
          echo "$NEW_POST_FILES"
          
          # Get the first new post file
          FIRST_NEW_POST=$(echo "$NEW_POST_FILES" | head -n 1)
          echo "post_file=${FIRST_NEW_POST}" >> $GITHUB_OUTPUT
          echo "has_new_posts=true" >> $GITHUB_OUTPUT
          
          echo "ðŸ“ Will publish: ${FIRST_NEW_POST}"

      - name: ðŸ Setup Python
        if: steps.detect.outputs.has_new_posts == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        if: steps.detect.outputs.has_new_posts == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium
          playwright install-deps

      - name: ðŸ“ Extract Post Metadata
        if: steps.detect.outputs.has_new_posts == 'true'
        id: metadata
        run: |
          POST_FILE="${{ steps.detect.outputs.post_file }}"
          echo "ðŸ“„ Extracting metadata from: ${POST_FILE}"
          
          # Extract metadata
          METADATA=$(python3 scripts/social/extract_metadata.py "${POST_FILE}")
          
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to extract metadata"
            exit 1
          fi
          
          # Parse metadata into variables
          while IFS='=' read -r key value; do
            case "$key" in
              TITLE) echo "title=${value}" >> $GITHUB_OUTPUT ;;
              CATEGORY) echo "category=${value}" >> $GITHUB_OUTPUT ;;
              TAGS) echo "tags=${value}" >> $GITHUB_OUTPUT ;;
              DATE) echo "date=${value}" >> $GITHUB_OUTPUT ;;
              URL) echo "url=${value}" >> $GITHUB_OUTPUT ;;
              DESCRIPTION) echo "description=${value}" >> $GITHUB_OUTPUT ;;
              LEARNING_POINTS) echo "learning_points=${value}" >> $GITHUB_OUTPUT ;;
            esac
          done <<< "$METADATA"
          
          echo "âœ… Metadata extracted successfully"

      - name: ðŸŽ¨ Generate OG Card Image
        if: steps.detect.outputs.has_new_posts == 'true'
        id: generate_image
        run: |
          # Extract slug from filename for image name
          POST_FILE="${{ steps.detect.outputs.post_file }}"
          SLUG=$(basename "${POST_FILE}" .md | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
          
          IMAGE_PATH="assets/og-images/${SLUG}.png"
          echo "image_path=${IMAGE_PATH}" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¨ Generating OG image: ${IMAGE_PATH}"
          
          python3 scripts/social/generate_og_image.py \
            "${{ steps.metadata.outputs.title }}" \
            "${{ steps.metadata.outputs.category }}" \
            "${{ steps.metadata.outputs.tags }}" \
            "${{ steps.metadata.outputs.date }}" \
            "${{ steps.metadata.outputs.learning_points }}" \
            "${IMAGE_PATH}"
          
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to generate OG image"
            exit 1
          fi
          
          echo "âœ… OG image generated successfully"

      - name: ðŸ’¾ Commit OG Image to Repository
        if: steps.detect.outputs.has_new_posts == 'true'
        run: |
          git config user.name "Youth Innovations Bot"
          git config user.email "info.youthinno@gmail.com"
          
          git add ${{ steps.generate_image.outputs.image_path }}
          
          if git diff --staged --quiet; then
            echo "ðŸ“­ No changes to commit"
          else
            git commit -m "ðŸŽ¨ Add OG image for: ${{ steps.metadata.outputs.title }}"
            git push
            echo "âœ… OG image committed to repository"
          fi

      - name: ðŸ¦ Post to Twitter/X
        if: steps.detect.outputs.has_new_posts == 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          # Install tweepy for Twitter API
          pip install tweepy
          
          # Post tweet using external script
          python3 scripts/social/post_tweet.py \
            "${{ steps.metadata.outputs.title }}" \
            "${{ steps.metadata.outputs.category }}" \
            "${{ steps.metadata.outputs.url }}" \
            "${{ steps.metadata.outputs.tags }}" \
            "${{ steps.metadata.outputs.learning_points }}" \
            "${{ steps.generate_image.outputs.image_path }}"
          
          echo "âœ… Tweet posted successfully!"

      - name: ðŸ“Š Summary
        if: always() && steps.detect.outputs.has_new_posts == 'true'
        run: |
          echo "## ðŸ“¢ Social Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Post:** ${{ steps.metadata.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Category:** ${{ steps.metadata.outputs.category }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **URL:** ${{ steps.metadata.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¨ **OG Image:** ${{ steps.generate_image.outputs.image_path }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¦ **Twitter:** Published!" >> $GITHUB_STEP_SUMMARY
