{% comment %}
  Code Playground Component
  Usage: {% include code-playground.html language="python" code="your code here" height="500" theme="dark" %}
  
  Parameters:
  - language: required (python, c, cpp, java, go, bash, javascript, etc.)
  - code: required (the code to pre-load)
  - height: optional (default: 500px)
  - theme: optional (default: dark)
  - gradient: optional (default: purple - options: purple, pink, green, orange)
{% endcomment %}

{% assign playground_height = include.height | default: "500" %}
{% assign playground_theme = include.theme | default: "dark" %}
{% assign playground_gradient = include.gradient | default: "purple" %}

{% if playground_gradient == "purple" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" %}
{% elsif playground_gradient == "pink" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" %}
{% elsif playground_gradient == "green" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" %}
{% elsif playground_gradient == "orange" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" %}
{% else %}
  {% assign gradient_style = "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" %}
{% endif %}

<details class="code-playground" style="margin: 20px 0; border: 2px solid #3498db; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
  <summary style="{{ gradient_style }} padding: 15px 20px; color: white; font-weight: bold; cursor: pointer; user-select: none;">
    ðŸš€ Try this Live â†’ Click to open interactive {{ include.language | upcase }} playground
  </summary>
  <div style="padding: 0;">
    <script type="application/json" class="playground-code">{{ include.code | jsonify }}</script>
    <iframe 
      class="onecompiler-iframe"
      frameborder="0" 
      width="100%" 
      height="{{ playground_height }}px" 
      src="https://onecompiler.com/embed/{{ include.language }}?hideLanguageSelection=true&hideNew=true&hideTitle=true&theme={{ playground_theme }}&listenToEvents=true"
      data-language="{{ include.language }}">
    </iframe>
  </div>
</details>

<script>
// Load the code playground initializer only once
if (!window.playgroundInitializerLoaded) {
  window.playgroundInitializerLoaded = true;
  
  // Send code to a specific iframe with retry logic
  function sendCodeToIframe(iframe, retryCount = 0) {
    var language = iframe.getAttribute('data-language');
    var initialized = iframe.getAttribute('data-initialized');
    
    // Skip if already initialized
    if (initialized === 'true') {
      return;
    }
    
    // Get code from script tag (stored as JSON)
    var codeScript = iframe.previousElementSibling;
    if (!codeScript || codeScript.type !== 'application/json') {
      console.error('Playground code script tag not found for', language);
      return;
    }
    
    var code;
    try {
      code = JSON.parse(codeScript.textContent);
    } catch (e) {
      console.error('Failed to parse playground code JSON for', language, ':', e);
      return;
    }
    
    if (!code || !language) {
      console.warn('Playground missing code or language for', language);
      return;
    }
    
    // Map language to proper file extension
    var fileExtension = language;
    if (language === 'typescript') fileExtension = 'ts';
    else if (language === 'javascript') fileExtension = 'js';
    else if (language === 'cpp') fileExtension = 'cpp';
    
    // Send code to iframe
    try {
      var message = {
        eventType: 'populateCode',
        language: language,
        files: [{
          name: 'main.' + fileExtension,
          content: code
        }]
      };
      
      iframe.contentWindow.postMessage(message, '*');
      iframe.setAttribute('data-initialized', 'true');
      console.log('âœ“ Successfully populated playground (' + language + ') after', retryCount, 'retries');
    } catch (e) {
      console.error('âœ— Failed to populate playground for', language, ':', e);
      
      // Retry with exponential backoff (up to 3 retries)
      if (retryCount < 3) {
        var delay = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
        console.log('ðŸ”„ Retrying playground population for', language, 'in', delay, 'ms (attempt', retryCount + 1, ')');
        setTimeout(function() {
          sendCodeToIframe(iframe, retryCount + 1);
        }, delay);
      } else {
        console.error('âŒ Giving up on playground population for', language, 'after 3 retries');
      }
    }
  }
  
  // Check if iframe is ready to receive messages
  function isIframeReady(iframe) {
    try {
      // Try to access iframe content to check if it's loaded
      return iframe.contentWindow && iframe.contentWindow.postMessage;
    } catch (e) {
      return false;
    }
  }
  
  // Initialize playgrounds - attach listeners to details elements
  function initPlaygrounds() {
    var playgrounds = document.querySelectorAll('.code-playground');
    console.log('ðŸŽ® Initializing', playgrounds.length, 'code playground(s)');
    
    playgrounds.forEach(function(details, index) {
      var iframe = details.querySelector('.onecompiler-iframe');
      if (!iframe) {
        console.warn('No iframe found for playground', index);
        return;
      }
      
      var language = iframe.getAttribute('data-language');
      console.log('Setting up playground for', language);
      
      // Listen for iframe load events
      iframe.addEventListener('load', function() {
        console.log('ðŸ“¦ Iframe loaded for', language, '- checking readiness...');
        
        // Wait a bit more for OneCompiler app to initialize
        setTimeout(function() {
          if (isIframeReady(iframe)) {
            console.log('âœ… Iframe ready for', language, '- sending code...');
            sendCodeToIframe(iframe);
          } else {
            console.warn('âš ï¸ Iframe not ready for', language, '- will retry on toggle');
          }
        }, 500);
      });
      
      // Listen for when details is opened
      details.addEventListener('toggle', function() {
        if (details.open) {
          console.log('ðŸ”“ Playground opened for', language);
          
          // If iframe is already loaded and ready, send code immediately
          if (isIframeReady(iframe) && iframe.getAttribute('data-initialized') !== 'true') {
            console.log('ðŸš€ Sending code immediately for', language);
            sendCodeToIframe(iframe);
          } else {
            // Otherwise, wait for iframe to be ready (with longer delay for production)
            console.log('â³ Waiting for iframe readiness for', language);
            setTimeout(function() {
              if (isIframeReady(iframe)) {
                sendCodeToIframe(iframe);
              } else {
                console.warn('Iframe still not ready for', language, '- will retry...');
                // Try again with longer delay
                setTimeout(function() {
                  sendCodeToIframe(iframe);
                }, 2000);
              }
            }, 1500); // Increased from 1000ms
          }
        }
      });
      
      // If already open, initialize immediately (with longer delay)
      if (details.open) {
        console.log('Playground already open for', language, '- initializing...');
        setTimeout(function() {
          if (isIframeReady(iframe)) {
            sendCodeToIframe(iframe);
          }
        }, 2000); // Increased from 1500ms
      }
    });
  }
  
  // Run on DOM ready and page load with staggered initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initPlaygrounds, 100);
    });
  } else {
    setTimeout(initPlaygrounds, 100);
  }
  
  // Additional initialization on window load
  window.addEventListener('load', function() {
    setTimeout(initPlaygrounds, 500);
  });
}
</script>
