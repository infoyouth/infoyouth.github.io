{% comment %}
  Code Playground Component
  Usage: {% include code-playground.html language="python" code="your code here" height="500" theme="dark" %}
  
  Parameters:
  - language: required (python, c, cpp, java, go, bash, javascript, etc.)
  - code: required (the code to pre-load)
  - height: optional (default: 500px)
  - theme: optional (default: dark)
  - gradient: optional (default: purple - options: purple, pink, green, orange)
{% endcomment %}

{% assign playground_height = include.height | default: "500" %}
{% assign playground_theme = include.theme | default: "dark" %}
{% assign playground_gradient = include.gradient | default: "purple" %}

{% if playground_gradient == "purple" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" %}
{% elsif playground_gradient == "pink" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" %}
{% elsif playground_gradient == "green" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" %}
{% elsif playground_gradient == "orange" %}
  {% assign gradient_style = "background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" %}
{% else %}
  {% assign gradient_style = "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" %}
{% endif %}

<details class="code-playground" style="margin: 20px 0; border: 2px solid #3498db; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
  <summary style="{{ gradient_style }} padding: 15px 20px; color: white; font-weight: bold; cursor: pointer; user-select: none;">
    üöÄ Try this Live ‚Üí Click to open interactive {{ include.language | upcase }} playground
  </summary>
  <div style="padding: 0;">
    <script type="application/json" class="playground-code">{{ include.code | jsonify }}</script>
    <iframe 
      class="onecompiler-iframe"
      frameborder="0" 
      width="100%" 
      height="{{ playground_height }}px" 
      src="https://onecompiler.com/embed/{{ include.language }}?hideLanguageSelection=true&hideNew=true&hideTitle=true&theme={{ playground_theme }}&listenToEvents=true"
      data-language="{{ include.language }}">
    </iframe>
  </div>
</details>

<script>
// Load the code playground initializer only once
if (!window.playgroundInitializerLoaded) {
  window.playgroundInitializerLoaded = true;
  
  // Send code to a specific iframe
  function sendCodeToIframe(iframe) {
    var language = iframe.getAttribute('data-language');
    var initialized = iframe.getAttribute('data-initialized');
    
    // Skip if already initialized
    if (initialized === 'true') {
      return;
    }
    
    // Get code from script tag (stored as JSON)
    var codeScript = iframe.previousElementSibling;
    if (!codeScript || codeScript.type !== 'application/json') {
      console.error('Playground code script tag not found');
      return;
    }
    
    var code;
    try {
      code = JSON.parse(codeScript.textContent);
    } catch (e) {
      console.error('Failed to parse playground code JSON:', e);
      return;
    }
    
    if (!code || !language) {
      console.warn('Playground missing code or language');
      return;
    }
    
    console.log('üîç DEBUG: Code length:', code.length);
    console.log('üîç DEBUG: Has newlines:', code.indexOf('\n') !== -1);
    console.log('üîç DEBUG: First 100 chars:', code.substring(0, 100));
    
    // Map language to proper file extension
    var fileExtension = language;
    if (language === 'typescript') fileExtension = 'ts';
    else if (language === 'javascript') fileExtension = 'js';
    else if (language === 'cpp') fileExtension = 'cpp';
    
    // Send code to iframe
    try {
      iframe.contentWindow.postMessage({
        eventType: 'populateCode',
        language: language,
        files: [{
          name: 'main.' + fileExtension,
          content: code
        }]
      }, '*');
      iframe.setAttribute('data-initialized', 'true');
      console.log('‚úì Populated playground (' + language + ')');
    } catch (e) {
      console.error('‚úó Failed to populate playground:', e);
    }
  }
  
  // Initialize playgrounds - attach listeners to details elements
  function initPlaygrounds() {
    var playgrounds = document.querySelectorAll('.code-playground');
    console.log('Found ' + playgrounds.length + ' playground(s)');
    
    playgrounds.forEach(function(details) {
      var iframe = details.querySelector('.onecompiler-iframe');
      if (!iframe) return;
      
      // Listen for when details is opened
      details.addEventListener('toggle', function() {
        if (details.open) {
          // Wait a bit for iframe to be visible and loaded
          setTimeout(function() {
            sendCodeToIframe(iframe);
          }, 1000);
        }
      });
      
      // If already open, initialize immediately
      if (details.open) {
        setTimeout(function() {
          sendCodeToIframe(iframe);
        }, 1500);
      }
    });
  }
  
  // Run on DOM ready and page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPlaygrounds);
  } else {
    initPlaygrounds();
  }
  window.addEventListener('load', function() {
    setTimeout(initPlaygrounds, 500);
  });
}
</script>
